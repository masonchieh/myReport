<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Blockly Mutator &#x958b;&#x767c;&#x7b46;&#x8a18;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <h1 id="blockly-mutator-é–‹ç™¼ç­†è¨˜">Blockly Mutator é–‹ç™¼ç­†è¨˜</h1>
<h2 id="-mutator-æ˜¯ä»€éº¼">ğŸ” Mutator æ˜¯ä»€éº¼ï¼Ÿ</h2>
<ul>
<li>Mutator çš„æ ¸å¿ƒå°±æ˜¯ï¼šUI è‡ªè®Šå½¢èƒ½åŠ› â†’ DOM ä¿å­˜ â†’ code generator å°æ‡‰</li>
<li>Mutator æ˜¯ Blockly çš„æ©Ÿåˆ¶ï¼Œè®“ç©æœ¨èƒ½å¤ æ ¹æ“šä½¿ç”¨è€…æ“ä½œï¼Œå‹•æ…‹èª¿æ•´å…¶å¤–å‹èˆ‡é‚è¼¯çµæ§‹ã€‚å¸¸è¦‹ç”¨é€”åŒ…æ‹¬ï¼š
<ul>
<li><code>if</code> ç©æœ¨æ”¯æ´å¤šå€‹ <code>else if</code> å’Œä¸€å€‹ <code>else</code></li>
<li><code>function</code> ç©æœ¨å¯å‹•æ…‹å¢åŠ åƒæ•¸æ¬„ä½</li>
<li><code>switch</code> ç©æœ¨å¯åŠ æ¸› case åˆ†æ”¯</li>
</ul>
</li>
</ul>
<h2 id="-mutator-çµ„æˆè¦ç´ ">ğŸ“¦ Mutator çµ„æˆè¦ç´ </h2>
<h3 id="1-block-å®šç¾©ä¸­çš„-mutator-å±¬æ€§">1. Block å®šç¾©ä¸­çš„ <code>mutator</code> å±¬æ€§</h3>
<pre><code class="language-ts">{
  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;control_if&#x27;</span>,
  <span class="hljs-attr">message0</span>: <span class="hljs-string">&#x27;if %1&#x27;</span>,
  <span class="hljs-attr">args0</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;input_value&#x27;</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;IF0&#x27;</span>, <span class="hljs-attr">check</span>: <span class="hljs-string">&#x27;Boolean&#x27;</span> }],
  <span class="hljs-attr">message1</span>: <span class="hljs-string">&#x27;do %1&#x27;</span>,
  <span class="hljs-attr">args1</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;input_statement&#x27;</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;DO0&#x27;</span> }],
  <span class="hljs-attr">previousStatement</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">nextStatement</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">mutator</span>: <span class="hljs-string">&#x27;controls_if_mutator&#x27;</span>,
  <span class="hljs-attr">colour</span>: <span class="hljs-number">210</span>,
  <span class="hljs-attr">tooltip</span>: <span class="hljs-string">&#x27;æ ¹æ“šæ¢ä»¶æ±ºå®šæ˜¯å¦åŸ·è¡Œå°æ‡‰ç¨‹å¼ç¢¼&#x27;</span>,
  <span class="hljs-attr">helpUrl</span>: <span class="hljs-string">&#x27;https://your-docs.com/block/control_if&#x27;</span>,
}
</code></pre>
<pre><code class="language-ts"><span class="hljs-comment">/**
 * æ“´å±• Blockly Block ä»‹é¢, ä»¥æ”¯æ´ mutator æ–¹æ³•
 * - mutator å®šç¾©èªªæ˜ï¼šMutator æ˜¯ Blockly ç©æœ¨çš„ã€Œè‡ªå®šç¾©è®Šå½¢æ©Ÿåˆ¶ã€ï¼Œè®“ç©æœ¨å¯ä»¥å‹•æ…‹ `æ“´å……` æˆ– `ç¸®æ¸›` å…¶è¼¸å…¥çµæ§‹
 * - ä¸»è¦ç”¨é€”ï¼š
 *   - å¢åŠ /ç§»é™¤ input å€¼ï¼šä¾‹å¦‚ if æ¢ä»¶å¯ä»¥æœ‰å¤šå€‹ else if æˆ–ä¸€å€‹ else
 *   - è¨­å®šæ¬„ä½æ•¸é‡æˆ–çµæ§‹ï¼šå¦‚ function declaration çš„åƒæ•¸æ•¸é‡å‹•æ…‹å¢æ¸›
 *   - å‹•æ…‹å„²å­˜è®Šç•°ç‹€æ…‹ï¼š`mutationToDom()` / `domToMutation()` å¯è®“ç©æœ¨ä¿å­˜ UI é…ç½®ç‹€æ…‹
 * - ç©æœ¨è¡Œç‚ºè½‰æ›ï¼š
 *   - æ²’æœ‰ Mutatorï¼š
 *     - çµæ§‹å›ºå®š
 *     - æ¬„ä½æ•¸ç›®ä¸€è‡´
 *     - è¼ƒé›£æ”¯æ´è¤‡é›œæµç¨‹
 *   - æœ‰ Mutatorï¼š
 *     - çµæ§‹å¯è®Š
 *     - å¯ä»¥æ ¹æ“šä½¿ç”¨è€…éœ€æ±‚è‡ªå‹•æ“´å……æ¬„ä½æˆ–å…§å®¹
 *     - æ”¯æ´åƒã€Œå¤šé‡ if æ¢ä»¶ã€ã€ã€Œå¤šåƒæ•¸å‡½å¼ã€ã€ã€Œå¯è®Šé¸é …åˆ—è¡¨ã€ç­‰è¤‡é›œé…ç½®
 * - Blockly å¦‚ä½•ä½¿ç”¨ Mutatorï¼š
 *   - Blockly å° mutator çš„æ”¯æ´é€éä»¥ä¸‹å¹¾å€‹å…ƒä»¶ï¼š
 *     - `mutator å±¬æ€§` â†’ åœ¨ block å®šç¾©ä¸­, æŒ‡åç”¨å“ªå€‹ mutator
 *     - defineBlocksWithJsonArray() â†’ ç”¨ä¾†å®šç¾© mutator å…§éƒ¨ç”¨çš„æ§åˆ¶ç©æœ¨ï¼ˆå¦‚ controls_if_if, controls_if_elseifï¼‰
 *     - registerMutator() â†’ è¨»å†Š Mutator mixin çš„è¡Œç‚ºå®šç¾©ï¼ŒåŒ…æ‹¬ `compose()` `updateShape_()` `mutationToDom()` `domToMutation()`
 * - çµè«–ï¼šMutator æ˜¯ Blockly å°ã€Œå¯è®Šçµæ§‹ç©æœ¨ã€çš„å®˜æ–¹æ©Ÿåˆ¶ï¼Œé©ç”¨æ–¼æ‰€æœ‰ UI å¯é…ç½®å‹ç©æœ¨ã€‚ä½ å®šç¾©çš„ control_if å°±æ˜¯ä¸€å€‹ Mutator çš„æœ€ä½³ç¯„ä¾‹ï¼Œæ”¯æ´å¤šæ¢ä»¶ã€å¤šæµç¨‹ã€å½ˆæ€§é‚è¼¯
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BlockWithMutator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Blockly</span>.<span class="hljs-title class_">Block</span> {
  <span class="hljs-attr">elseifCount_</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">elseCount_</span>: <span class="hljs-built_in">number</span>;
  rebuildShape_?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
  updateShape_?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>; <span class="hljs-comment">// è¨­ç‚ºå¯é¸ï¼Œä¸¦åœ¨èª¿ç”¨æ™‚åšç©ºå€¼æª¢æŸ¥</span>

  <span class="hljs-comment">// ä»¥ä¸‹æ˜¯æ–°å¢çš„ mutator ç›¸é—œæ–¹æ³•</span>
  <span class="hljs-title function_">mutationToDom</span>(): <span class="hljs-title class_">Element</span>;
  <span class="hljs-title function_">domToMutation</span>(<span class="hljs-attr">xmlElement</span>: <span class="hljs-title class_">Element</span>): <span class="hljs-built_in">void</span>;
  <span class="hljs-title function_">decompose</span>(<span class="hljs-attr">workspace</span>: <span class="hljs-title class_">Blockly</span>.<span class="hljs-property">Workspace</span>): <span class="hljs-title class_">Blockly</span>.<span class="hljs-property">Block</span>;
  <span class="hljs-title function_">compose</span>(<span class="hljs-attr">containerBlock</span>: <span class="hljs-title class_">Blockly</span>.<span class="hljs-property">Block</span>): <span class="hljs-built_in">void</span>;
  <span class="hljs-title function_">saveConnections</span>(<span class="hljs-attr">containerBlock</span>: <span class="hljs-title class_">Blockly</span>.<span class="hljs-property">Block</span>): <span class="hljs-built_in">void</span>;
  <span class="hljs-comment">// å°‡ reconnectChildBlocks_ ç§»åˆ°é€™è£¡ï¼Œå› ç‚ºå®ƒåœ¨ mutator æ··å…¥ä¸­ä½¿ç”¨</span>
  reconnectChildBlocks_?: <span class="hljs-function">(<span class="hljs-params">valueConnections: (Blockly.Connection | <span class="hljs-literal">null</span>)[], statementConnections: (Blockly.Connection | <span class="hljs-literal">null</span>)[]</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}
</code></pre>
<pre><code class="language-ts"><span class="hljs-comment">/** åˆå§‹åŒ–æ‰€æœ‰`é‚è¼¯`ç©æœ¨ */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initLogicBlocks</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title class_">Blockly</span>.<span class="hljs-title function_">defineBlocksWithJsonArray</span>([
    control_if,
  ]);

  <span class="hljs-comment">// è¨»å†Š if çš„ mutator</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">CONTROLS_IF_MUTATOR_MIXIN</span>: <span class="hljs-built_in">any</span> = { <span class="hljs-comment">// ä½¿ç”¨ any æš«æ™‚è¦é¿é¡å‹æª¢æŸ¥å•é¡Œï¼Œæˆ–è©³ç´°å®šç¾© BlockWithMutator</span>
    <span class="hljs-attr">elseifCount_</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">elseCount_</span>: <span class="hljs-number">0</span>,

    <span class="hljs-attr">mutationToDom</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span>: BlockWithMutator</span>): <span class="hljs-title class_">Element</span> {
      <span class="hljs-comment">// ä¿®æ­£ï¼šå³ä½¿æ²’æœ‰è®Šç•°ï¼Œä¹Ÿè¿”å›ä¸€å€‹ç©ºçš„ &lt;mutation/&gt; å…ƒç´ ï¼Œè€Œä¸æ˜¯ null</span>
      <span class="hljs-keyword">const</span> container = <span class="hljs-title class_">Blockly</span>.<span class="hljs-property">utils</span>.<span class="hljs-property">xml</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;mutation&#x27;</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">elseifCount_</span>) {
        container.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;elseif&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">elseifCount_</span>.<span class="hljs-title function_">toString</span>());
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">elseCount_</span>) {
        container.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;else&#x27;</span>, <span class="hljs-string">&#x27;1&#x27;</span>);
      }
      <span class="hljs-keyword">return</span> container;
    },

    <span class="hljs-attr">domToMutation</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span>: BlockWithMutator, xmlElement: Element</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">elseifCount_</span> = <span class="hljs-built_in">parseInt</span>(xmlElement.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;elseif&#x27;</span>) || <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-number">10</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">elseCount_</span> = <span class="hljs-built_in">parseInt</span>(xmlElement.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;else&#x27;</span>) || <span class="hljs-string">&#x27;0&#x27;</span>, <span class="hljs-number">10</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateShape_</span>?.(); <span class="hljs-comment">// ä½¿ç”¨ updateShape_ ä¾†é‡å»ºç©æœ¨å¤–å½¢</span>
    },

    <span class="hljs-comment">/**
     * Creates the mutator&#x27;s dialog for adding/removing conditions.
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">!Blockly.Workspace</span>} workspace The workspace to place the mutator&#x27;s
     * blocks in.
     * <span class="hljs-doctag">@return</span> {<span class="hljs-type">!Blockly.Block</span>} The root block in the mutator dialog.
     */</span>
    <span class="hljs-attr">decompose</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span>: BlockWithMutator, workspace: Blockly.Workspace</span>) {
      <span class="hljs-keyword">const</span> containerBlock = workspace.<span class="hljs-title function_">newBlock</span>(<span class="hljs-string">&#x27;controls_if_if&#x27;</span>);
      <span class="hljs-comment">// ä¿®æ­£ï¼šç§»é™¤ .initSvg()ï¼Œæ–°ç‰ˆ Blockly æœƒè‡ªå‹•è™•ç† containerBlock.initSvg();</span>
      <span class="hljs-keyword">let</span> connection = containerBlock.<span class="hljs-property">nextConnection</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">elseifCount_</span>; i++) {
        <span class="hljs-keyword">const</span> elseifBlock = workspace.<span class="hljs-title function_">newBlock</span>(<span class="hljs-string">&#x27;controls_if_elseif&#x27;</span>);
        <span class="hljs-comment">// ä¿®æ­£ï¼šç§»é™¤ .initSvg()ï¼Œæ–°ç‰ˆ Blockly æœƒè‡ªå‹•è™•ç† elseifBlock.initSvg();</span>
        <span class="hljs-keyword">if</span> (connection) { <span class="hljs-comment">// ç¢ºä¿ connection å­˜åœ¨</span>
          connection.<span class="hljs-title function_">connect</span>(elseifBlock.<span class="hljs-property">previousConnection</span>!);
        }
        connection = elseifBlock.<span class="hljs-property">nextConnection</span>;
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">elseCount_</span>) {
        <span class="hljs-keyword">const</span> elseBlock = workspace.<span class="hljs-title function_">newBlock</span>(<span class="hljs-string">&#x27;controls_if_else&#x27;</span>);
        <span class="hljs-comment">// ä¿®æ­£ï¼šç§»é™¤ .initSvg()ï¼Œæ–°ç‰ˆ Blockly æœƒè‡ªå‹•è™•ç† elseBlock.initSvg();</span>
        <span class="hljs-keyword">if</span> (connection) { <span class="hljs-comment">// ç¢ºä¿ connection å­˜åœ¨</span>
          connection.<span class="hljs-title function_">connect</span>(elseBlock.<span class="hljs-property">previousConnection</span>!);
        }
      }
      <span class="hljs-keyword">return</span> containerBlock;
    },

    <span class="hljs-comment">/**
     * Reconfigure this block based on the mutator dialog&#x27;s blocks.
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">!Blockly.Block</span>} containerBlock Root block in mutator.
     */</span>
    <span class="hljs-attr">compose</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span>: BlockWithMutator, containerBlock: Blockly.Block</span>) {
      <span class="hljs-comment">// æ–·é–‹æ‰€æœ‰èˆŠçš„é€£æ¥ä¸¦ä¿å­˜</span>
      <span class="hljs-keyword">const</span> <span class="hljs-attr">valueConnections</span>: (<span class="hljs-title class_">Blockly</span>.<span class="hljs-property">Connection</span> | <span class="hljs-literal">null</span>)[] = [<span class="hljs-literal">null</span>];
      <span class="hljs-keyword">const</span> <span class="hljs-attr">statementConnections</span>: (<span class="hljs-title class_">Blockly</span>.<span class="hljs-property">Connection</span> | <span class="hljs-literal">null</span>)[] = [<span class="hljs-literal">null</span>];

      <span class="hljs-comment">// ä¿å­˜ç¾æœ‰ IF/DO é€£æ¥</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">elseifCount_</span>; i++) {
        <span class="hljs-keyword">const</span> inputIf = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInput</span>(<span class="hljs-string">&#x27;IF&#x27;</span> + i);
        <span class="hljs-keyword">const</span> inputDo = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInput</span>(<span class="hljs-string">&#x27;DO&#x27;</span> + i);
        <span class="hljs-keyword">if</span> (inputIf?.<span class="hljs-property">connection</span>) {
          valueConnections.<span class="hljs-title function_">push</span>(inputIf.<span class="hljs-property">connection</span>.<span class="hljs-property">targetConnection</span>);
        }
        <span class="hljs-keyword">if</span> (inputDo?.<span class="hljs-property">connection</span>) {
          statementConnections.<span class="hljs-title function_">push</span>(inputDo.<span class="hljs-property">connection</span>.<span class="hljs-property">targetConnection</span>);
        }
      }

      <span class="hljs-comment">// ä¿å­˜ ELSE é€£æ¥</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">elseCount_</span>) {
        <span class="hljs-keyword">const</span> elseInput = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInput</span>(<span class="hljs-string">&#x27;ELSE&#x27;</span>);
        <span class="hljs-keyword">if</span> (elseInput?.<span class="hljs-property">connection</span>) {
          statementConnections.<span class="hljs-title function_">push</span>(elseInput.<span class="hljs-property">connection</span>.<span class="hljs-property">targetConnection</span>);
        }
      }

      <span class="hljs-comment">// é‡è¨­ elseif å’Œ else è¨ˆæ•¸</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">elseifCount_</span> = <span class="hljs-number">0</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">elseCount_</span> = <span class="hljs-number">0</span>;

      <span class="hljs-comment">// éæ­· mutator ä¸­çš„ç©æœ¨ï¼Œæ›´æ–°è¨ˆæ•¸</span>
      <span class="hljs-keyword">let</span> childBlock = containerBlock.<span class="hljs-property">nextConnection</span>?.<span class="hljs-title function_">targetBlock</span>();
      <span class="hljs-keyword">while</span> (childBlock) {
        <span class="hljs-keyword">switch</span> (childBlock.<span class="hljs-property">type</span>) {
          <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;controls_if_elseif&#x27;</span>:
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">elseifCount_</span>++;
            <span class="hljs-keyword">break</span>;
          <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;controls_if_else&#x27;</span>:
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">elseCount_</span>++;
            <span class="hljs-keyword">break</span>;
          <span class="hljs-attr">default</span>:
            <span class="hljs-keyword">break</span>;
        }
        childBlock = childBlock.<span class="hljs-property">nextConnection</span>?.<span class="hljs-title function_">targetBlock</span>();
      }

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateShape_</span>?.(); <span class="hljs-comment">// æ ¹æ“šæ–°çš„è¨ˆæ•¸é‡å»ºå½¢ç‹€</span>

      <span class="hljs-comment">// é‡æ–°é€£æ¥å­ç©æœ¨</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectChildBlocks_</span>?.(valueConnections, statementConnections);
    },

    <span class="hljs-comment">/**
     * Store pointers to any connected child blocks.
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">!Blockly.Block</span>} _containerBlock The container block in
     * the mutator.
     * <span class="hljs-doctag">@this</span> {<span class="hljs-type">Blockly.Block</span>}
     */</span>
    <span class="hljs-attr">saveConnections</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span>: BlockWithMutator, _containerBlock: Blockly.Block</span>) {
      <span class="hljs-comment">// Not typically needed for simple if mutator, as connections are handled in compose.</span>
      <span class="hljs-comment">// But can be used to store connections for blocks that might be removed during compose.</span>
    },

    <span class="hljs-attr">updateShape_</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span>: BlockWithMutator</span>) {
      <span class="hljs-comment">// ç§»é™¤æ‰€æœ‰é¡å¤–çš„è¼¸å…¥</span>
      <span class="hljs-comment">// ç§»é™¤ç¾æœ‰çš„ IF/DO è¼¸å…¥ï¼Œé™¤äº† IF0/DO0</span>
      <span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>;
      <span class="hljs-keyword">while</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInput</span>(<span class="hljs-string">&#x27;IF&#x27;</span> + i)) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeInput</span>(<span class="hljs-string">&#x27;IF&#x27;</span> + i);
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeInput</span>(<span class="hljs-string">&#x27;DO&#x27;</span> + i);
        i++;
      }
      <span class="hljs-comment">// ç§»é™¤ ELSE è¼¸å…¥</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInput</span>(<span class="hljs-string">&#x27;ELSE&#x27;</span>)) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeInput</span>(<span class="hljs-string">&#x27;ELSE&#x27;</span>);
      }

      <span class="hljs-comment">// é‡å»º elseif è¼¸å…¥</span>
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">elseifCount_</span>; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">appendValueInput</span>(<span class="hljs-string">&#x27;IF&#x27;</span> + i)
            .<span class="hljs-title function_">setCheck</span>(<span class="hljs-string">&#x27;Boolean&#x27;</span>)
            .<span class="hljs-title function_">appendField</span>(<span class="hljs-string">&#x27;else if&#x27;</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">appendStatementInput</span>(<span class="hljs-string">&#x27;DO&#x27;</span> + i)
            .<span class="hljs-title function_">appendField</span>(<span class="hljs-string">&#x27;do&#x27;</span>);
      }

      <span class="hljs-comment">// é‡å»º else è¼¸å…¥</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">elseCount_</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">appendStatementInput</span>(<span class="hljs-string">&#x27;ELSE&#x27;</span>)
            .<span class="hljs-title function_">appendField</span>(<span class="hljs-string">&#x27;else&#x27;</span>);
      }
    },

    <span class="hljs-attr">reconnectChildBlocks_</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">
      <span class="hljs-variable language_">this</span>: BlockWithMutator,
      valueConnections: (Blockly.Connection | <span class="hljs-literal">null</span>)[],
      statementConnections: (Blockly.Connection | <span class="hljs-literal">null</span>)[]
    </span>) {
      <span class="hljs-comment">// é‡æ–°é€£æ¥ IF/DO è¼¸å…¥ (åŒ…æ‹¬ IF0/DO0)</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">elseifCount_</span>; i++) { <span class="hljs-comment">// æ³¨æ„é€™è£¡å¾ 0 é–‹å§‹ï¼Œå› ç‚º IF0/DO0 ä¹Ÿè¦è™•ç†</span>
        <span class="hljs-keyword">const</span> valueInput = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInput</span>(<span class="hljs-string">&#x27;IF&#x27;</span> + i);
        <span class="hljs-keyword">const</span> statementInput = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInput</span>(<span class="hljs-string">&#x27;DO&#x27;</span> + i);
        
        <span class="hljs-keyword">if</span> (valueInput?.<span class="hljs-property">connection</span> &amp;&amp; valueConnections[i]) {
          <span class="hljs-keyword">try</span> {
            valueInput.<span class="hljs-property">connection</span>.<span class="hljs-title function_">connect</span>(valueConnections[i]!);
          } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&#x27;Failed to reconnect value input IF&#x27;</span> + i + <span class="hljs-string">&#x27;:&#x27;</span>, e);
          }
        }
        
        <span class="hljs-keyword">if</span> (statementInput?.<span class="hljs-property">connection</span> &amp;&amp; statementConnections[i]) {
          <span class="hljs-keyword">try</span> {
            statementInput.<span class="hljs-property">connection</span>.<span class="hljs-title function_">connect</span>(statementConnections[i]!);
          } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&#x27;Failed to reconnect statement input DO&#x27;</span> + i + <span class="hljs-string">&#x27;:&#x27;</span>, e);
          }
        }
      }

      <span class="hljs-comment">// é‡æ–°é€£æ¥ ELSE è¼¸å…¥ (å¦‚æœå­˜åœ¨)</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">elseCount_</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInput</span>(<span class="hljs-string">&#x27;ELSE&#x27;</span>)) {
        <span class="hljs-keyword">const</span> elseInput = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getInput</span>(<span class="hljs-string">&#x27;ELSE&#x27;</span>);
        <span class="hljs-comment">// else çš„é€£æ¥æ˜¯ statementConnections é™£åˆ—çš„æœ€å¾Œä¸€å€‹å…ƒç´ </span>
        <span class="hljs-comment">// é€™è£¡éœ€è¦ç¢ºä¿ç´¢å¼•æ­£ç¢ºï¼Œå› ç‚º valueConnections å’Œ statementConnections æ˜¯é‡å° IF/DO çš„ï¼Œ</span>
        <span class="hljs-comment">// ELSE çš„ç´¢å¼•æœƒæ˜¯ elseifCount_ + 1</span>
        <span class="hljs-keyword">const</span> elseIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-property">elseifCount_</span> + <span class="hljs-number">1</span>;
        <span class="hljs-keyword">const</span> lastStatementConnection = statementConnections[elseIndex];
        
        <span class="hljs-keyword">if</span> (elseInput?.<span class="hljs-property">connection</span> &amp;&amp; lastStatementConnection) {
          <span class="hljs-keyword">try</span> {
            elseInput.<span class="hljs-property">connection</span>.<span class="hljs-title function_">connect</span>(lastStatementConnection);
          } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&#x27;Failed to reconnect else input:&#x27;</span>, e);
          }
        }
      }
    },
  };

  <span class="hljs-comment">// è¨»å†Š mutator</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title class_">Blockly</span>.<span class="hljs-property">Extensions</span>.<span class="hljs-title function_">registerMutator</span>(
      <span class="hljs-string">&#x27;controls_if_mutator&#x27;</span>,
      <span class="hljs-variable constant_">CONTROLS_IF_MUTATOR_MIXIN</span>,
      <span class="hljs-literal">undefined</span>, <span class="hljs-comment">// Opt_helperFn</span>
      [<span class="hljs-string">&#x27;controls_if_elseif&#x27;</span>, <span class="hljs-string">&#x27;controls_if_else&#x27;</span>]
    );
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&#x27;Failed to register controls_if_mutator:&#x27;</span>, error);
  }

  <span class="hljs-comment">// è¨»å†Š mutator å…§éƒ¨ä½¿ç”¨çš„ç©æœ¨ (controls_if_if, controls_if_elseif, controls_if_else)</span>
  <span class="hljs-title class_">Blockly</span>.<span class="hljs-title function_">defineBlocksWithJsonArray</span>([
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;controls_if_if&#x27;</span>,
      <span class="hljs-attr">message0</span>: <span class="hljs-string">&#x27;if&#x27;</span>,
      <span class="hljs-comment">// previousStatement and nextStatement for mutator blocks are defined in their init methods below</span>
      <span class="hljs-attr">colour</span>: <span class="hljs-number">210</span>,
      <span class="hljs-attr">tooltip</span>: <span class="hljs-string">&#x27;æ§åˆ¶ if å€å¡Šçš„ mutator&#x27;</span>,
      <span class="hljs-attr">helpUrl</span>: <span class="hljs-string">&#x27;&#x27;</span>,
    },
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;controls_if_elseif&#x27;</span>,
      <span class="hljs-attr">message0</span>: <span class="hljs-string">&#x27;else if&#x27;</span>,
      <span class="hljs-comment">// previousStatement and nextStatement for mutator blocks are defined in their init methods below</span>
      <span class="hljs-attr">colour</span>: <span class="hljs-number">210</span>,
      <span class="hljs-attr">tooltip</span>: <span class="hljs-string">&#x27;æ·»åŠ  else if æ¢ä»¶&#x27;</span>,
      <span class="hljs-attr">helpUrl</span>: <span class="hljs-string">&#x27;&#x27;</span>,
    },
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;controls_if_else&#x27;</span>,
      <span class="hljs-attr">message0</span>: <span class="hljs-string">&#x27;else&#x27;</span>,
      <span class="hljs-comment">// previousStatement and nextStatement for mutator blocks are defined in their init methods below</span>
      <span class="hljs-attr">colour</span>: <span class="hljs-number">210</span>,
      <span class="hljs-attr">tooltip</span>: <span class="hljs-string">&#x27;æ·»åŠ  else æ¢ä»¶&#x27;</span>,
      <span class="hljs-attr">helpUrl</span>: <span class="hljs-string">&#x27;&#x27;</span>,
    },
  ]);

  <span class="hljs-comment">// ä¿®æ­£ mutator å…§éƒ¨ç©æœ¨çš„é€£æ¥é¡å‹ï¼Œä½¿å…¶èƒ½å¤ æ­£ç¢ºé€£æ¥</span>
  <span class="hljs-comment">// å¦å‰‡å®ƒå€‘åœ¨ mutator å·¥ä½œå€ä¸­ç„¡æ³•é€£æ¥</span>
  <span class="hljs-comment">// é€™äº›æ‡‰è©²æ˜¯é€£æ¥å™¨ (connections)ï¼Œä¸æ˜¯ statement æˆ– input</span>
  <span class="hljs-comment">// initSvg ç§»é™¤å¾Œï¼Œé€™äº›å…§éƒ¨ç©æœ¨å¯èƒ½éœ€è¦é¡å¤–çš„é€£æ¥å®šç¾©</span>
  <span class="hljs-comment">// ä»¥ä¾¿åœ¨ mutator å·¥ä½œå€ä¸­èƒ½å¤ ä¸²è¯</span>
  <span class="hljs-title class_">Blockly</span>.<span class="hljs-property">Blocks</span>[<span class="hljs-string">&#x27;controls_if_if&#x27;</span>].<span class="hljs-property">init</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">appendDummyInput</span>().<span class="hljs-title function_">appendField</span>(<span class="hljs-string">&#x27;if&#x27;</span>);
    <span class="hljs-comment">// ä½¿ç”¨ &#x27;controls_if_container_stack&#x27; ä½œç‚ºé€šç”¨é€£æ¥é¡å‹</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setNextStatement</span>(<span class="hljs-literal">true</span>, <span class="hljs-string">&#x27;controls_if_container_stack&#x27;</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setColour</span>(<span class="hljs-number">210</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setTooltip</span>(<span class="hljs-string">&#x27;æ§åˆ¶ if å€å¡Šçš„ mutator&#x27;</span>);
  };

  <span class="hljs-title class_">Blockly</span>.<span class="hljs-property">Blocks</span>[<span class="hljs-string">&#x27;controls_if_elseif&#x27;</span>].<span class="hljs-property">init</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">appendDummyInput</span>().<span class="hljs-title function_">appendField</span>(<span class="hljs-string">&#x27;else if&#x27;</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setPreviousStatement</span>(<span class="hljs-literal">true</span>, <span class="hljs-string">&#x27;controls_if_container_stack&#x27;</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setNextStatement</span>(<span class="hljs-literal">true</span>, <span class="hljs-string">&#x27;controls_if_container_stack&#x27;</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setColour</span>(<span class="hljs-number">210</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setTooltip</span>(<span class="hljs-string">&#x27;æ·»åŠ  else if æ¢ä»¶&#x27;</span>);
  };

  <span class="hljs-title class_">Blockly</span>.<span class="hljs-property">Blocks</span>[<span class="hljs-string">&#x27;controls_if_else&#x27;</span>].<span class="hljs-property">init</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">appendDummyInput</span>().<span class="hljs-title function_">appendField</span>(<span class="hljs-string">&#x27;else&#x27;</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setPreviousStatement</span>(<span class="hljs-literal">true</span>, <span class="hljs-string">&#x27;controls_if_container_stack&#x27;</span>);
    <span class="hljs-comment">// else æ˜¯æœ€å¾Œä¸€å€‹ï¼Œæ‰€ä»¥æ²’æœ‰ nextStatement</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setNextStatement</span>(<span class="hljs-literal">false</span>); <span class="hljs-comment">// æ˜ç¢ºè¨­å®šç‚º false</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setColour</span>(<span class="hljs-number">210</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setTooltip</span>(<span class="hljs-string">&#x27;æ·»åŠ  else æ¢ä»¶&#x27;</span>);
  };
}
</code></pre>

            
            
        </body>
        </html>